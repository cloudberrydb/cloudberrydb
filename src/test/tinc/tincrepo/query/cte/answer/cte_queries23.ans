-- @author prabhd 
-- @created 2012-02-01 12:00:00 
-- @modified 2013-02-01 12:00:00 
-- @tags cte HAWQ 
-- @product_version gpdb: [4.3-],hawq: [1.1-]
-- @db_name world_db
-- @gucs enable_seqscan=off;enable_indexscan=on
-- @description cte tests from cdbfast 
-- queries with CTEs on AO tables
--query1
with capitals as 
(select country_ao.code,id,city_ao.name from city_ao,country_ao 
 where city_ao.countrycode = country_ao.code AND city_ao.id = country_ao.capital) 
select * from 
capitals,countrylanguage_ao
where capitals.code = countrylanguage_ao.countrycode and isofficial='true'
order by capitals.code,countrylanguage_ao.language;
 code |  id  |               name                | countrycode |     language     | isofficial | percentage 
------+------+-----------------------------------+-------------+------------------+------------+------------
 ABW  |  129 | Oranjestad                        | ABW         | Dutch            | t          |        5.3
 AFG  |    1 | Kabul                             | AFG         | Dari             | t          |       32.1
 AFG  |    1 | Kabul                             | AFG         | Pashto           | t          |       52.4
 AIA  |   62 | The Valley                        | AIA         | English          | t          |          0
 ALB  |   34 | Tirana                            | ALB         | Albaniana        | t          |       97.9
 AND  |   55 | Andorra la Vella                  | AND         | Catalan          | t          |       32.3
 ANT  |   33 | Willemstad                        | ANT         | Dutch            | t          |          0
 ANT  |   33 | Willemstad                        | ANT         | Papiamento       | t          |       86.2
 ARE  |   65 | Abu Dhabi                         | ARE         | Arabic           | t          |         42
 ARG  |   69 | Buenos Aires                      | ARG         | Spanish          | t          |       96.8
 ARM  |  126 | Yerevan                           | ARM         | Armenian         | t          |       93.4
 ASM  |   54 | Fagatogo                          | ASM         | English          | t          |        3.1
 ASM  |   54 | Fagatogo                          | ASM         | Samoan           | t          |       90.6
 ATG  |   63 | Saint Johns                       | ATG         | English          | t          |          0
 AUS  |  135 | Canberra                          | AUS         | English          | t          |       81.2
 AUT  | 1523 | Wien                              | AUT         | German           | t          |         92
 AZE  |  144 | Baku                              | AZE         | Azerbaijani      | t          |         89
 BDI  |  552 | Bujumbura                         | BDI         | French           | t          |          0
 BDI  |  552 | Bujumbura                         | BDI         | Kirundi          | t          |       98.1
 BEL  |  179 | Bruxelles [Brussel]               | BEL         | Dutch            | t          |       59.2
 BEL  |  179 | Bruxelles [Brussel]               | BEL         | French           | t          |       32.6
 BEL  |  179 | Bruxelles [Brussel]               | BEL         | German           | t          |          1
 BGD  |  150 | Dhaka                             | BGD         | Bengali          | t          |       97.7
 BGR  |  539 | Sofija                            | BGR         | Bulgariana       | t          |       83.2
 BHR  |  149 | al-Manama                         | BHR         | Arabic           | t          |       67.7
 BIH  |  201 | Sarajevo                          | BIH         | Serbo-Croatian   | t          |       99.2
 BLR  | 3520 | Minsk                             | BLR         | Belorussian      | t          |       65.6
 BLR  | 3520 | Minsk                             | BLR         | Russian          | t          |         32
 BLZ  |  185 | Belmopan                          | BLZ         | English          | t          |       50.8
 BMU  |  191 | Hamilton                          | BMU         | English          | t          |        100
 BOL  |  194 | La Paz                            | BOL         | Aimara           | t          |        3.2
 BOL  |  194 | La Paz                            | BOL         | Ketdua           | t          |        8.1
 BOL  |  194 | La Paz                            | BOL         | Spanish          | t          |       87.7
 BRA  |  211 | Brasilia                          | BRA         | Portuguese       | t          |       97.5
 BRB  |  174 | Bridgetown                        | BRB         | English          | t          |          0
 BRN  |  538 | Bandar Seri Begawan               | BRN         | Malay            | t          |       45.5
 BTN  |  192 | Thimphu                           | BTN         | Dzongkha         | t          |         50
 CAN  | 1822 | Ottawa                            | CAN         | English          | t          |       60.4
 CAN  | 1822 | Ottawa                            | CAN         | French           | t          |       23.4
 CCK  | 2317 | West Island                       | CCK         | English          | t          |          0
 CHE  | 3248 | Bern                              | CHE         | French           | t          |       19.2
 CHE  | 3248 | Bern                              | CHE         | German           | t          |       63.6
 CHE  | 3248 | Bern                              | CHE         | Italian          | t          |        7.7
 CHE  | 3248 | Bern                              | CHE         | Romansh          | t          |        0.6
 CHL  |  554 | Santiago de Chile                 | CHL         | Spanish          | t          |       89.7
 CHN  | 1891 | Peking                            | CHN         | Chinese          | t          |         92
 COK  |  583 | Avarua                            | COK         | Maori            | t          |          0
 COL  | 2257 | Santafe de Bogota                 | COL         | Spanish          | t          |         99
 COM  | 2295 | Moroni                            | COM         | Comorian         | t          |         75
 CPV  | 1859 | Praia                             | CPV         | Portuguese       | t          |          0
 CRI  |  584 | San Jose                          | CRI         | Spanish          | t          |       97.5
 CUB  | 2413 | La Habana                         | CUB         | Spanish          | t          |        100
 CXR  | 1791 | Flying Fish Cove                  | CXR         | English          | t          |          0
 CYM  |  553 | George Town                       | CYM         | English          | t          |          0
 CYP  | 2430 | Nicosia                           | CYP         | Greek            | t          |       74.1
 CYP  | 2430 | Nicosia                           | CYP         | Turkish          | t          |       22.4
 CZE  | 3339 | Praha                             | CZE         | Czech            | t          |       81.2
 DEU  | 3068 | Berlin                            | DEU         | German           | t          |       91.3
 DJI  |  585 | Djibouti                          | DJI         | Arabic           | t          |       10.6
 DNK  | 3315 | Kobenhavn                         | DNK         | Danish           | t          |       93.5
 DOM  |  587 | Santo Domingo de Guzman           | DOM         | Spanish          | t          |         98
 DZA  |   35 | Alger                             | DZA         | Arabic           | t          |         86
 ECU  |  594 | Quito                             | ECU         | Spanish          | t          |         93
 EGY  |  608 | Cairo                             | EGY         | Arabic           | t          |       98.8
 ERI  |  652 | Asmara                            | ERI         | Tigrinja         | t          |       49.1
 ESH  | 2453 | El-Aaiun                          | ESH         | Arabic           | t          |        100
 ESP  |  653 | Madrid                            | ESP         | Spanish          | t          |       74.4
 EST  | 3791 | Tallinn                           | EST         | Estonian         | t          |       65.3
 FIN  | 3236 | Helsinki [Helsingfors]            | FIN         | Finnish          | t          |       92.7
 FIN  | 3236 | Helsinki [Helsingfors]            | FIN         | Swedish          | t          |        5.7
 FJI  |  764 | Suva                              | FJI         | Fijian           | t          |       50.8
 FLK  |  763 | Stanley                           | FLK         | English          | t          |          0
 FRA  | 2974 | Paris                             | FRA         | French           | t          |       93.6
 FRO  |  901 | Torshavn                          | FRO         | Danish           | t          |          0
 FRO  |  901 | Torshavn                          | FRO         | Faroese          | t          |        100
 GBR  |  456 | London                            | GBR         | English          | t          |       97.3
 GEO  |  905 | Tbilisi                           | GEO         | Georgiana        | t          |       71.7
 GIB  |  915 | Gibraltar                         | GIB         | English          | t          |       88.9
 GLP  |  919 | Basse-Terre                       | GLP         | French           | t          |          0
 GNB  |  927 | Bissau                            | GNB         | Portuguese       | t          |        8.1
 GRC  | 2401 | Athenai                           | GRC         | Greek            | t          |       98.5
 GRL  |  917 | Nuuk                              | GRL         | Danish           | t          |       12.5
 GRL  |  917 | Nuuk                              | GRL         | Greenlandic      | t          |       87.5
 GTM  |  922 | Ciudad de Guatemala               | GTM         | Spanish          | t          |       64.7
 GUM  |  921 | Agaaa                             | GUM         | Chamorro         | t          |       29.6
 GUM  |  921 | Agaaa                             | GUM         | English          | t          |       37.5
 HKG  |  937 | Victoria                          | HKG         | English          | t          |        2.2
 HND  |  933 | Tegucigalpa                       | HND         | Spanish          | t          |       97.2
 HRV  | 2409 | Zagreb                            | HRV         | Serbo-Croatian   | t          |       95.9
 HTI  |  929 | Port-au-Prince                    | HTI         | French           | t          |          0
 HUN  | 3483 | Budapest                          | HUN         | Hungarian        | t          |       98.5
 IDN  |  939 | Jakarta                           | IDN         | Malay            | t          |       12.1
 IND  | 1109 | New Delhi                         | IND         | Hindi            | t          |       39.9
 IRL  | 1447 | Dublin                            | IRL         | English          | t          |       98.4
 IRL  | 1447 | Dublin                            | IRL         | Irish            | t          |        1.6
 IRN  | 1380 | Teheran                           | IRN         | Persian          | t          |       45.7
 IRQ  | 1365 | Baghdad                           | IRQ         | Arabic           | t          |       77.2
 ISL  | 1449 | Reykjavik                         | ISL         | Icelandic        | t          |       95.7
 ISR  | 1450 | Jerusalem                         | ISR         | Arabic           | t          |         18
 ISR  | 1450 | Jerusalem                         | ISR         | Hebrew           | t          |       63.1
 ITA  | 1464 | Roma                              | ITA         | Italian          | t          |       94.1
 JOR  | 1786 | Amman                             | JOR         | Arabic           | t          |       97.9
 JPN  | 1532 | Tokyo                             | JPN         | Japanese         | t          |       99.1
 KAZ  | 1864 | Astana                            | KAZ         | Kazakh           | t          |         46
 KGZ  | 2253 | Bishkek                           | KGZ         | Kirgiz           | t          |       59.7
 KGZ  | 2253 | Bishkek                           | KGZ         | Russian          | t          |       16.2
 KHM  | 1800 | Phnom Penh                        | KHM         | Khmer            | t          |       88.6
 KIR  | 2256 | Bairiki                           | KIR         | Kiribati         | t          |       98.9
 KNA  | 3064 | Basseterre                        | KNA         | English          | t          |          0
 KOR  | 2331 | Seoul                             | KOR         | Korean           | t          |       99.9
 KWT  | 2429 | Kuwait                            | KWT         | Arabic           | t          |       78.1
 LAO  | 2432 | Vientiane                         | LAO         | Lao              | t          |       67.2
 LBN  | 2438 | Beirut                            | LBN         | Arabic           | t          |         93
 LBY  | 2441 | Tripoli                           | LBY         | Arabic           | t          |         96
 LCA  | 3065 | Castries                          | LCA         | English          | t          |         20
 LIE  | 2446 | Vaduz                             | LIE         | German           | t          |         89
 LKA  | 3217 | Colombo                           | LKA         | Singali          | t          |       60.3
 LKA  | 3217 | Colombo                           | LKA         | Tamil            | t          |       19.6
 LSO  | 2437 | Maseru                            | LSO         | English          | t          |          0
 LSO  | 2437 | Maseru                            | LSO         | Sotho            | t          |         85
 LTU  | 2447 | Vilnius                           | LTU         | Lithuanian       | t          |       81.6
 LUX  | 2452 | Luxembourg [Luxemburg/Letzebuerg] | LUX         | French           | t          |        4.2
 LUX  | 2452 | Luxembourg [Luxemburg/Letzebuerg] | LUX         | German           | t          |        2.3
 LUX  | 2452 | Luxembourg [Luxemburg/Letzebuerg] | LUX         | Luxembourgish    | t          |       64.4
 LVA  | 2434 | Riga                              | LVA         | Latvian          | t          |       55.1
 MAC  | 2454 | Macao                             | MAC         | Portuguese       | t          |        2.3
 MAR  | 2486 | Rabat                             | MAR         | Arabic           | t          |         65
 MCO  | 2695 | Monaco-Ville                      | MCO         | French           | t          |       41.9
 MDA  | 2690 | Chisinau                          | MDA         | Romanian         | t          |       61.9
 MDG  | 2455 | Antananarivo                      | MDG         | French           | t          |          0
 MDG  | 2455 | Antananarivo                      | MDG         | Malagasy         | t          |       98.9
 MDV  | 2463 | Male                              | MDV         | Dhivehi          | t          |        100
 MEX  | 2515 | Ciudad de Mexico                  | MEX         | Spanish          | t          |       92.1
 MHL  | 2507 | Dalap-Uliga-Darrit                | MHL         | English          | t          |          0
 MHL  | 2507 | Dalap-Uliga-Darrit                | MHL         | Marshallese      | t          |       96.8
 MKD  | 2460 | Skopje                            | MKD         | Macedonian       | t          |       66.5
 MLT  | 2484 | Valletta                          | MLT         | English          | t          |        2.1
 MLT  | 2484 | Valletta                          | MLT         | Maltese          | t          |       95.8
 MMR  | 2710 | Rangoon (Yangon)                  | MMR         | Burmese          | t          |         69
 MNG  | 2696 | Ulan Bator                        | MNG         | Mongolian        | t          |       78.8
 MNP  | 2913 | Garapan                           | MNP         | English          | t          |        4.8
 MSR  | 2697 | Plymouth                          | MSR         | English          | t          |          0
 MTQ  | 2508 | Fort-de-France                    | MTQ         | French           | t          |          0
 MWI  | 2462 | Lilongwe                          | MWI         | Chichewa         | t          |       58.3
 MYS  | 2464 | Kuala Lumpur                      | MYS         | Malay            | t          |       58.4
 MYT  | 2514 | Mamoutzou                         | MYT         | French           | t          |       20.3
 NCL  | 3493 | Noumea                            | NCL         | French           | t          |       34.3
 NFK  | 2806 | Kingston                          | NFK         | English          | t          |          0
 NIC  | 2734 | Managua                           | NIC         | Spanish          | t          |       97.6
 NIU  | 2805 | Alofi                             | NIU         | English          | t          |          0
 NLD  |    5 | Amsterdam                         | NLD         | Dutch            | t          |       95.6
 NOR  | 2807 | Oslo                              | NOR         | Norwegian        | t          |       96.6
 NPL  | 2729 | Kathmandu                         | NPL         | Nepali           | t          |       50.4
 NRU  | 2728 | Yaren                             | NRU         | English          | t          |        7.5
 NRU  | 2728 | Yaren                             | NRU         | Nauru            | t          |       57.5
 NZL  | 3499 | Wellington                        | NZL         | English          | t          |         87
 OMN  | 2821 | Masqat                            | OMN         | Arabic           | t          |       76.7
 PAK  | 2831 | Islamabad                         | PAK         | Urdu             | t          |        7.6
 PAN  | 2882 | Ciudad de Panama                  | PAN         | Spanish          | t          |       76.8
 PER  | 2890 | Lima                              | PER         | Aimara           | t          |        2.3
 PER  | 2890 | Lima                              | PER         | Ketdua           | t          |       16.4
 PER  | 2890 | Lima                              | PER         | Spanish          | t          |       79.8
 PHL  |  766 | Manila                            | PHL         | Pilipino         | t          |       29.3
 PLW  | 2881 | Koror                             | PLW         | English          | t          |        3.2
 PLW  | 2881 | Koror                             | PLW         | Palau            | t          |       82.2
 POL  | 2928 | Warszawa                          | POL         | Polish           | t          |       97.6
 PRI  | 2919 | San Juan                          | PRI         | Spanish          | t          |       51.3
 PRK  | 2318 | Pyongyang                         | PRK         | Korean           | t          |       99.9
 PRT  | 2914 | Lisboa                            | PRT         | Portuguese       | t          |         99
 PRY  | 2885 | Asuncion                          | PRY         | Guarani          | t          |       40.1
 PRY  | 2885 | Asuncion                          | PRY         | Spanish          | t          |       55.1
 PYF  | 3016 | Papeete                           | PYF         | French           | t          |       40.8
 QAT  | 2973 | Doha                              | QAT         | Arabic           | t          |       40.7
 ROM  | 3018 | Bucuresti                         | ROM         | Romani           | t          |        0.7
 ROM  | 3018 | Bucuresti                         | ROM         | Romanian         | t          |       90.7
 RUS  | 3580 | Moscow                            | RUS         | Russian          | t          |       86.6
 RWA  | 3047 | Kigali                            | RWA         | French           | t          |          0
 RWA  | 3047 | Kigali                            | RWA         | Rwanda           | t          |        100
 SAU  | 3173 | Riyadh                            | SAU         | Arabic           | t          |         95
 SDN  | 3225 | Khartum                           | SDN         | Arabic           | t          |       49.4
 SEN  | 3198 | Dakar                             | SEN         | Wolof            | t          |       48.1
 SGP  | 3208 | Singapore                         | SGP         | Chinese          | t          |       77.1
 SGP  | 3208 | Singapore                         | SGP         | Malay            | t          |       14.1
 SGP  | 3208 | Singapore                         | SGP         | Tamil            | t          |        7.4
 SHN  | 3063 | Jamestown                         | SHN         | English          | t          |          0
 SJM  |  938 | Longyearbyen                      | SJM         | Norwegian        | t          |          0
 SLV  |  645 | San Salvador                      | SLV         | Spanish          | t          |        100
 SMR  | 3171 | San Marino                        | SMR         | Italian          | t          |        100
 SOM  | 3214 | Mogadishu                         | SOM         | Arabic           | t          |          0
 SOM  | 3214 | Mogadishu                         | SOM         | Somali           | t          |       98.3
 SPM  | 3067 | Saint-Pierre                      | SPM         | French           | t          |          0
 SVK  | 3209 | Bratislava                        | SVK         | Slovak           | t          |       85.6
 SVN  | 3212 | Ljubljana                         | SVN         | Slovene          | t          |       87.9
 SWE  | 3048 | Stockholm                         | SWE         | Swedish          | t          |       89.5
 SWZ  | 3244 | Mbabane                           | SWZ         | Swazi            | t          |       89.9
 SYC  | 3206 | Victoria                          | SYC         | English          | t          |        3.8
 SYC  | 3206 | Victoria                          | SYC         | French           | t          |        1.3
 SYR  | 3250 | Damascus                          | SYR         | Arabic           | t          |         90
 TCA  | 3423 | Cockburn Town                     | TCA         | English          | t          |          0
 TCD  | 3337 | NDjamena                          | TCD         | Arabic           | t          |       12.3
 TGO  | 3332 | Lome                              | TGO         | Ewe              | t          |       23.2
 TGO  | 3332 | Lome                              | TGO         | Kabye            | t          |       13.8
 THA  | 3320 | Bangkok                           | THA         | Thai             | t          |       52.6
 TJK  | 3261 | Dushanbe                          | TJK         | Tadzhik          | t          |       62.2
 TKL  | 3333 | Fakaofo                           | TKL         | English          | t          |          0
 TKM  | 3419 | Ashgabat                          | TKM         | Turkmenian       | t          |       76.7
 TMP  | 1522 | Dili                              | TMP         | Portuguese       | t          |          0
 TON  | 3334 | Nukualofa                         | TON         | English          | t          |          0
 TON  | 3334 | Nukualofa                         | TON         | Tongan           | t          |       98.3
 TUN  | 3349 | Tunis                             | TUN         | Arabic           | t          |       69.9
 TUR  | 3358 | Ankara                            | TUR         | Turkish          | t          |       87.6
 TUV  | 3424 | Funafuti                          | TUV         | English          | t          |          0
 TUV  | 3424 | Funafuti                          | TUV         | Tuvalu           | t          |       92.5
 TWN  | 3263 | Taipei                            | TWN         | Mandarin Chinese | t          |       20.1
 TZA  | 3306 | Dodoma                            | TZA         | Swahili          | t          |        8.8
 UKR  | 3426 | Kyiv                              | UKR         | Ukrainian        | t          |       64.7
 URY  | 3492 | Montevideo                        | URY         | Spanish          | t          |       95.7
 USA  | 3813 | Washington                        | USA         | English          | t          |       86.2
 UZB  | 3503 | Toskent                           | UZB         | Uzbek            | t          |       72.6
 VAT  | 3538 | Citta del Vaticano                | VAT         | Italian          | t          |          0
 VCT  | 3066 | Kingstown                         | VCT         | English          | t          |          0
 VEN  | 3539 | Caracas                           | VEN         | Spanish          | t          |       96.9
 VGB  |  537 | Road Town                         | VGB         | English          | t          |          0
 VIR  | 4067 | Charlotte Amalie                  | VIR         | English          | t          |       81.7
 VNM  | 3770 | Hanoi                             | VNM         | Vietnamese       | t          |       86.8
 VUT  | 3537 | Port-Vila                         | VUT         | Bislama          | t          |       56.6
 VUT  | 3537 | Port-Vila                         | VUT         | English          | t          |       28.3
 VUT  | 3537 | Port-Vila                         | VUT         | French           | t          |       14.2
 WSM  | 3169 | Apia                              | WSM         | English          | t          |        0.6
 WSM  | 3169 | Apia                              | WSM         | Samoan           | t          |       47.5
 YEM  | 1780 | Sanaa                             | YEM         | Arabic           | t          |       99.6
 YUG  | 1792 | Beograd                           | YUG         | Serbo-Croatian   | t          |       75.2
 ZAF  |  716 | Pretoria                          | ZAF         | Afrikaans        | t          |       14.3
 ZAF  |  716 | Pretoria                          | ZAF         | English          | t          |        8.5
 ZAF  |  716 | Pretoria                          | ZAF         | Xhosa            | t          |       17.7
 ZAF  |  716 | Pretoria                          | ZAF         | Zulu             | t          |       22.7
 ZWE  | 4068 | Harare                            | ZWE         | English          | t          |        2.2
(237 rows)

--query2
with lang_total as
( select count(*) as lang_count,country_ao.code,countrylanguage_ao.countrycode
  from country_ao join countrylanguage_ao on (country_ao.code=countrylanguage_ao.countrycode and governmentform='Federal Republic')
  group by country_ao.code,countrylanguage_ao.countrycode order by country_ao.code)
 
select lang_count,country_ao.code,country_ao.name,country_ao.continent,country_ao.region,country_ao.population
 from country_ao left outer join lang_total
 on (lang_total.code = country_ao.code)
 where country_ao.indepyear > 1970 and lang_total.lang_count >=1 and lang_total.lang_count >=1
  order by lang_total.lang_count desc;
 lang_count | code |              name               | continent |     region      | population 
------------+------+---------------------------------+-----------+-----------------+------------
         12 | RUS  | Russian Federation              | Europe    | Eastern Europe  |  146934000
          6 | FSM  | Micronesia, Federated States of | Oceania   | Micronesia      |     119000
          4 | AZE  | Azerbaijan                      | Asia      | Middle East     |    7734000
          1 | BIH  | Bosnia and Herzegovina          | Europe    | Southern Europe |    3972000
(4 rows)

-- Using CTE in the WHERE clause
--query3
with lang_total as
( select lang_count,countrycode from
  (
  (
   select count(*) as lang_count,country_ao.code,countrylanguage_ao.countrycode
  from country_ao join countrylanguage_ao on (country_ao.code=countrylanguage_ao.countrycode and governmentform='Federal Republic')
  group by country_ao.code,countrylanguage_ao.countrycode order by country_ao.code)
 
   UNION ALL
 
  (
   select count(*) as lang_count,country_ao.code,countrylanguage_ao.countrycode
  from country_ao join countrylanguage_ao on (country_ao.code=countrylanguage_ao.countrycode and governmentform='Monarchy')
  group by country_ao.code,countrylanguage_ao.countrycode order by country_ao.code)
 
 ) FOO1
)
select * from
(
select count(*) as cnt,country_ao.code,country_ao.name 
from
country_ao,countrylanguage_ao
where country_ao.code=countrylanguage_ao.countrycode group by country_ao.code,country_ao.name) AS FOO
where foo.cnt = (select max(lang_count) from lang_total) order by foo.code;
 cnt | code |        name        
-----+------+--------------------
  12 | CAN  | Canada
  12 | CHN  | China
  12 | IND  | India
  12 | RUS  | Russian Federation
  12 | USA  | United States
(5 rows)

--query4
with diversecountries as
(select country_ao.code,country_ao.name,country_ao.capital,d.CNT
 from country_ao,
 (select countrylanguage_ao.countrycode,count(*) as CNT from countrylanguage_ao group by countrycode
  HAVING count(*) > 6) d
 where d.countrycode = country_ao.code and country_ao.gnp > 100000)
 select diversecountries.name,city_ao.name,diversecountries.CNT
 from diversecountries,city_ao where city_ao.id = diversecountries.capital
 order by diversecountries.name;
        name        |       name       | cnt 
--------------------+------------------+-----
 Australia          | Canberra         |   8
 Austria            | Wien             |   8
 Canada             | Ottawa           |  12
 China              | Peking           |  12
 Denmark            | Kobenhavn        |   7
 India              | New Delhi        |  12
 Iran               | Teheran          |  10
 Italy              | Roma             |   8
 Myanmar            | Rangoon (Yangon) |   8
 Russian Federation | Moscow           |  12
 South Africa       | Pretoria         |  11
 United States      | Washington       |  12
(12 rows)

-- some queries with merge joins and index scans
set enable_nestloop=off;
SET
set enable_hashjoin=off;
SET
set enable_mergejoin=on;
SET
-- query 5
with somecheapasiandiversecountries as
(
 select FOO.code,FOO.COUNTRY_AO,FOO.CAPITAL,FOO.headofstate,count(*) ASIAN_COUNT from
 (
 select country_ao.code,country_ao.name COUNTRY_AO,city_ao.name CAPITAL,country_ao.headofstate
 from country_ao,city_ao
 where country_ao.capital = city_ao.id 
 and country_ao.gnp < 10000
 and country_ao.region = 'Southeast Asia'
 and country_ao.continent = 'Asia'
 
 UNION ALL
 select country_ao.code,country_ao.name COUNTRY_AO,city_ao.name CAPITAL,country_ao.headofstate
 from country_ao,city_ao
 where country_ao.capital = city_ao.id 
 and country_ao.gnp < 10000
 and country_ao.region = 'Eastern Asia'
 and country_ao.continent = 'Asia'
 UNION ALL
 select country_ao.code,country_ao.name COUNTRY_AO,city_ao.name CAPITAL,country_ao.headofstate
 from country_ao,city_ao
 where country_ao.capital = city_ao.id 
 and country_ao.gnp < 10000
 and country_ao.region = 'Middle East'
 and country_ao.continent = 'Asia'
 ) FOO, countrylanguage_ao
 where FOO.code = countrylanguage_ao.countrycode
 group by FOO.code,FOO.COUNTRY_AO,FOO.CAPITAL,FOO.headofstate,countrylanguage_ao.countrycode
 HAVING count(*) >=
 (select min(CNT) FROM
   (select count(*) CNT,country_ao.code from countrylanguage_ao,country_ao
    where countrylanguage_ao.countrycode=country_ao.code
    and country_ao.continent = 'Asia'
    and country_ao.region = 'Southern and Central Asia'
    group by country_ao.code
   ) FOO1
 )
)
select FOO.code,FOO.COUNTRY_AO,FOO.CAPITAL,FOO.headofstate,count(*) COMPARED_WITH_CHEAP_ASIAN_CNT
from
(
select country_ao.code,country_ao.name COUNTRY_AO,city_ao.name CAPITAL,country_ao.headofstate
from country_ao,city_ao
where country_ao.capital = city_ao.id 
and country_ao.continent = 'North America'
UNION ALL
select country_ao.code,country_ao.name COUNTRY_AO,city_ao.name CAPITAL,country_ao.headofstate
from country_ao,city_ao
where country_ao.capital =	city_ao.id	
and country_ao.continent =	'South America'
) FOO,countrylanguage_ao
where FOO.code = countrylanguage_ao.countrycode
group by FOO.code,FOO.COUNTRY_AO,FOO.CAPITAL,FOO.headofstate
HAVING count(*)  >=
 (select min(ASIAN_COUNT) FROM
   (select ASIAN_COUNT FROM somecheapasiandiversecountries,country_ao
    where somecheapasiandiversecountries.code = country_ao.code
    and country_ao.gnp >= country_ao.gnpold
   ) ASIANCOUNT
 )
order by COUNTRY_AO;
 code |            country_ao            |         capital         |            headofstate            | compared_with_cheap_asian_cnt 
------+----------------------------------+-------------------------+-----------------------------------+-------------------------------
 ATG  | Antigua and Barbuda              | Saint Johns             | Elisabeth II                      |                             2
 ARG  | Argentina                        | Buenos Aires            | Fernando de la Rua                |                             3
 ABW  | Aruba                            | Oranjestad              | Beatrix                           |                             4
 BHS  | Bahamas                          | Nassau                  | Elisabeth II                      |                             2
 BRB  | Barbados                         | Bridgetown              | Elisabeth II                      |                             2
 BLZ  | Belize                           | Belmopan                | Elisabeth II                      |                             4
 BOL  | Bolivia                          | La Paz                  | Hugo Banzer Suarez                |                             4
 BRA  | Brazil                           | Brasilia                | Fernando Henrique Cardoso         |                             5
 CAN  | Canada                           | Ottawa                  | Elisabeth II                      |                            12
 CHL  | Chile                            | Santiago de Chile       | Ricardo Lagos Escobar             |                             4
 COL  | Colombia                         | Santafe de Bogota       | Andres Pastrana Arango            |                             5
 CRI  | Costa Rica                       | San Jose                | Miguel Angel Rodriguez Echeverria |                             4
 DMA  | Dominica                         | Roseau                  | Vernon Shaw                       |                             2
 DOM  | Dominican Republic               | Santo Domingo de Guzman | Hipolito Mejia Dominguez          |                             2
 ECU  | Ecuador                          | Quito                   | Gustavo Noboa Bejarano            |                             2
 SLV  | El Salvador                      | San Salvador            | Francisco Guillermo Flores Perez  |                             2
 GUF  | French Guiana                    | Cayenne                 | Jacques Chirac                    |                             2
 GRL  | Greenland                        | Nuuk                    | Margrethe II                      |                             2
 GLP  | Guadeloupe                       | Basse-Terre             | Jacques Chirac                    |                             2
 GTM  | Guatemala                        | Ciudad de Guatemala     | Alfonso Portillo Cabrera          |                             5
 GUY  | Guyana                           | Georgetown              | Bharrat Jagdeo                    |                             3
 HTI  | Haiti                            | Port-au-Prince          | Jean-Bertrand Aristide            |                             2
 HND  | Honduras                         | Tegucigalpa             | Carlos Roberto Flores Facusse     |                             4
 JAM  | Jamaica                          | Kingston                | Elisabeth II                      |                             2
 MTQ  | Martinique                       | Fort-de-France          | Jacques Chirac                    |                             2
 MEX  | Mexico                           | Ciudad de Mexico        | Vicente Fox Quesada               |                             6
 ANT  | Netherlands Antilles             | Willemstad              | Beatrix                           |                             3
 NIC  | Nicaragua                        | Managua                 | Arnoldo Aleman Lacayo             |                             4
 PAN  | Panama                           | Ciudad de Panama        | Mireya Elisa Moscoso Rodriguez    |                             6
 PRY  | Paraguay                         | Asuncion                | Luis Angel Gonzalez Macchi        |                             4
 PER  | Peru                             | Lima                    | Valentin Paniagua Corazao         |                             3
 PRI  | Puerto Rico                      | San Juan                | George W. Bush                    |                             2
 KNA  | Saint Kitts and Nevis            | Basseterre              | Elisabeth II                      |                             2
 LCA  | Saint Lucia                      | Castries                | Elisabeth II                      |                             2
 VCT  | Saint Vincent and the Grenadines | Kingstown               | Elisabeth II                      |                             2
 SUR  | Suriname                         | Paramaribo              | Ronald Venetiaan                  |                             2
 TTO  | Trinidad and Tobago              | Port-of-Spain           | Arthur N. R. Robinson             |                             3
 USA  | United States                    | Washington              | George W. Bush                    |                            12
 VEN  | Venezuela                        | Caracas                 | Hugo Chavez Frias                 |                             3
 VIR  | Virgin Islands, U.S.             | Charlotte Amalie        | George W. Bush                    |                             3
(40 rows)

-- query 6 
 
select count(*) from
( select r.* from
  ( with fact as 
     (
      select country_ao.name as COUNTRY_AO,country_ao.code,city_ao.name as CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,AGG1.region
      from      
         (select
         sum(case when (city_ao.population >= 0.5 * country_ao.population) then country_ao.population else city_ao.population end) as S_POPULATION,
         sum(case when (gnp >= gnpold) then gnp else gnpold end) as S_GNP,
         avg(case when (lifeexpectancy > 60) then 50 else lifeexpectancy end) as AVG_LIFE,country_ao.region
         from country_ao,city_ao  
         where governmentform != 'Constitutional Monarchy'
         and country_ao.capital = city_ao.id
         and indepyear > 0
         group by country_ao.region) AGG1
         ,country_ao,city_ao
         where country_ao.capital = city_ao.id
         and country_ao.region = AGG1.region
      )
     
     select code,COUNTRY_AO,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage_ao
     where fact.code = countrylanguage_ao.countrycode and isofficial = 'True'
     and fact.region = 'South America'
     
     UNION ALL
     
     select code,COUNTRY_AO,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage_ao
     where fact.code = countrylanguage_ao.countrycode and isofficial = 'True'
     and fact.region = 'North America'
     
     UNION ALL
     
     select code,COUNTRY_AO,CAPITAL,S_POPULATION,S_GNP,AVG_LIFE,language as OFFICIALLANGUAGE,region
     from fact,countrylanguage_ao
     where fact.code = countrylanguage_ao.countrycode and isofficial = 'True'
     and fact.region = 'Caribbean'
 ) as r
 left join
  (
   select 'ARG' as CODE UNION ALL
   select 'BOL' as CODE UNION ALL
   select 'BRA' as CODE UNION ALL
   select 'PER' as CODE UNION ALL
   select 'URY' as CODE UNION ALL
   select 'IND' as CODE  UNION ALL
   select 'LCA' as CODE UNION ALL
   select 'VCT' as CODE
   ) as r1
on r.code = r1.code) AS FOO;
 count 
-------
    43
(1 row)

-- query7
with alleuropeanlanguages as 
(select country_ao.code,country_ao.name COUNTRY_AO, city_ao.name CAPITAL, language, isofficial, percentage
 FROM country_ao,city_ao,countrylanguage_ao
 WHERE country_ao.code = countrylanguage_ao.countrycode
 and country_ao.capital = city_ao.id
 and country_ao.continent = 'Europe')
select * from
(select * from alleuropeanlanguages where isofficial='True') e1,
(select * from alleuropeanlanguages where percentage > 50) e2
where e1.code = e2.code order by e2.COUNTRY_AO,e1.language;
 code |       country_ao       |              capital              |    language    | isofficial | percentage | code |       country_ao       |              capital              |    language    | isofficial | percentage 
------+------------------------+-----------------------------------+----------------+------------+------------+------+------------------------+-----------------------------------+----------------+------------+------------
 ALB  | Albania                | Tirana                            | Albaniana      | t          |       97.9 | ALB  | Albania                | Tirana                            | Albaniana      | t          |       97.9
 AUT  | Austria                | Wien                              | German         | t          |         92 | AUT  | Austria                | Wien                              | German         | t          |         92
 BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6 | BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6
 BLR  | Belarus                | Minsk                             | Russian        | t          |         32 | BLR  | Belarus                | Minsk                             | Belorussian    | t          |       65.6
 BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BEL  | Belgium                | Bruxelles [Brussel]               | French         | t          |       32.6 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BEL  | Belgium                | Bruxelles [Brussel]               | German         | t          |          1 | BEL  | Belgium                | Bruxelles [Brussel]               | Dutch          | t          |       59.2
 BIH  | Bosnia and Herzegovina | Sarajevo                          | Serbo-Croatian | t          |       99.2 | BIH  | Bosnia and Herzegovina | Sarajevo                          | Serbo-Croatian | t          |       99.2
 BGR  | Bulgaria               | Sofija                            | Bulgariana     | t          |       83.2 | BGR  | Bulgaria               | Sofija                            | Bulgariana     | t          |       83.2
 HRV  | Croatia                | Zagreb                            | Serbo-Croatian | t          |       95.9 | HRV  | Croatia                | Zagreb                            | Serbo-Croatian | t          |       95.9
 CZE  | Czech Republic         | Praha                             | Czech          | t          |       81.2 | CZE  | Czech Republic         | Praha                             | Czech          | t          |       81.2
 DNK  | Denmark                | Kobenhavn                         | Danish         | t          |       93.5 | DNK  | Denmark                | Kobenhavn                         | Danish         | t          |       93.5
 EST  | Estonia                | Tallinn                           | Estonian       | t          |       65.3 | EST  | Estonia                | Tallinn                           | Estonian       | t          |       65.3
 FRO  | Faroe Islands          | Torshavn                          | Danish         | t          |          0 | FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100
 FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100 | FRO  | Faroe Islands          | Torshavn                          | Faroese        | t          |        100
 FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7 | FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7
 FIN  | Finland                | Helsinki [Helsingfors]            | Swedish        | t          |        5.7 | FIN  | Finland                | Helsinki [Helsingfors]            | Finnish        | t          |       92.7
 FRA  | France                 | Paris                             | French         | t          |       93.6 | FRA  | France                 | Paris                             | French         | t          |       93.6
 DEU  | Germany                | Berlin                            | German         | t          |       91.3 | DEU  | Germany                | Berlin                            | German         | t          |       91.3
 GIB  | Gibraltar              | Gibraltar                         | English        | t          |       88.9 | GIB  | Gibraltar              | Gibraltar                         | English        | t          |       88.9
 GRC  | Greece                 | Athenai                           | Greek          | t          |       98.5 | GRC  | Greece                 | Athenai                           | Greek          | t          |       98.5
 HUN  | Hungary                | Budapest                          | Hungarian      | t          |       98.5 | HUN  | Hungary                | Budapest                          | Hungarian      | t          |       98.5
 ISL  | Iceland                | Reykjavik                         | Icelandic      | t          |       95.7 | ISL  | Iceland                | Reykjavik                         | Icelandic      | t          |       95.7
 IRL  | Ireland                | Dublin                            | English        | t          |       98.4 | IRL  | Ireland                | Dublin                            | English        | t          |       98.4
 IRL  | Ireland                | Dublin                            | Irish          | t          |        1.6 | IRL  | Ireland                | Dublin                            | English        | t          |       98.4
 ITA  | Italy                  | Roma                              | Italian        | t          |       94.1 | ITA  | Italy                  | Roma                              | Italian        | t          |       94.1
 LVA  | Latvia                 | Riga                              | Latvian        | t          |       55.1 | LVA  | Latvia                 | Riga                              | Latvian        | t          |       55.1
 LIE  | Liechtenstein          | Vaduz                             | German         | t          |         89 | LIE  | Liechtenstein          | Vaduz                             | German         | t          |         89
 LTU  | Lithuania              | Vilnius                           | Lithuanian     | t          |       81.6 | LTU  | Lithuania              | Vilnius                           | Lithuanian     | t          |       81.6
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | French         | t          |        4.2 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | German         | t          |        2.3 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4 | LUX  | Luxembourg             | Luxembourg [Luxemburg/Letzebuerg] | Luxembourgish  | t          |       64.4
 MKD  | Macedonia              | Skopje                            | Macedonian     | t          |       66.5 | MKD  | Macedonia              | Skopje                            | Macedonian     | t          |       66.5
 MLT  | Malta                  | Valletta                          | English        | t          |        2.1 | MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8
 MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8 | MLT  | Malta                  | Valletta                          | Maltese        | t          |       95.8
 MDA  | Moldova                | Chisinau                          | Romanian       | t          |       61.9 | MDA  | Moldova                | Chisinau                          | Romanian       | t          |       61.9
 NLD  | Netherlands            | Amsterdam                         | Dutch          | t          |       95.6 | NLD  | Netherlands            | Amsterdam                         | Dutch          | t          |       95.6
 NOR  | Norway                 | Oslo                              | Norwegian      | t          |       96.6 | NOR  | Norway                 | Oslo                              | Norwegian      | t          |       96.6
 POL  | Poland                 | Warszawa                          | Polish         | t          |       97.6 | POL  | Poland                 | Warszawa                          | Polish         | t          |       97.6
 PRT  | Portugal               | Lisboa                            | Portuguese     | t          |         99 | PRT  | Portugal               | Lisboa                            | Portuguese     | t          |         99
 ROM  | Romania                | Bucuresti                         | Romani         | t          |        0.7 | ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7
 ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7 | ROM  | Romania                | Bucuresti                         | Romanian       | t          |       90.7
 RUS  | Russian Federation     | Moscow                            | Russian        | t          |       86.6 | RUS  | Russian Federation     | Moscow                            | Russian        | t          |       86.6
 SMR  | San Marino             | San Marino                        | Italian        | t          |        100 | SMR  | San Marino             | San Marino                        | Italian        | t          |        100
 SVK  | Slovakia               | Bratislava                        | Slovak         | t          |       85.6 | SVK  | Slovakia               | Bratislava                        | Slovak         | t          |       85.6
 SVN  | Slovenia               | Ljubljana                         | Slovene        | t          |       87.9 | SVN  | Slovenia               | Ljubljana                         | Slovene        | t          |       87.9
 ESP  | Spain                  | Madrid                            | Spanish        | t          |       74.4 | ESP  | Spain                  | Madrid                            | Spanish        | t          |       74.4
 SWE  | Sweden                 | Stockholm                         | Swedish        | t          |       89.5 | SWE  | Sweden                 | Stockholm                         | Swedish        | t          |       89.5
 CHE  | Switzerland            | Bern                              | French         | t          |       19.2 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | German         | t          |       63.6 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | Italian        | t          |        7.7 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 CHE  | Switzerland            | Bern                              | Romansh        | t          |        0.6 | CHE  | Switzerland            | Bern                              | German         | t          |       63.6
 UKR  | Ukraine                | Kyiv                              | Ukrainian      | t          |       64.7 | UKR  | Ukraine                | Kyiv                              | Ukrainian      | t          |       64.7
 GBR  | United Kingdom         | London                            | English        | t          |       97.3 | GBR  | United Kingdom         | London                            | English        | t          |       97.3
 YUG  | Yugoslavia             | Beograd                           | Serbo-Croatian | t          |       75.2 | YUG  | Yugoslavia             | Beograd                           | Serbo-Croatian | t          |       75.2
(55 rows)

-- query8
with allcountry_aostats as 
( select country_ao.code,country_ao.name,count(distinct city_ao.id) CITY_AO_CNT,
  count(distinct countrylanguage_ao.language) LANG_CNT
  from country_ao,city_ao,countrylanguage_ao
  where country_ao.code = city_ao.countrycode
  and country_ao.code = countrylanguage_ao.countrycode
  group by country_ao.code,country_ao.name
)
select sum(FOO.CITY_AO_CNT) REGION_CITY_AO_CNT,sum(FOO.LANG_CNT) REGION_LANG_CNT,FOO.region
FROM
(
select allcountry_aostats.code,allcountry_aostats.name COUNTRY_AO,CITY_AO_CNT,LANG_CNT,country_ao.region,city_ao.name CAPITAL
from allcountry_aostats,country_ao,city_ao
where allcountry_aostats.code = country_ao.code
and country_ao.capital = city_ao.id
and CITY_AO_CNT/LANG_CNT > 1
and country_ao.continent = 'Asia'
UNION ALL
select allcountry_aostats.code,allcountry_aostats.name COUNTRY_AO,CITY_AO_CNT,LANG_CNT,country_ao.region,city_ao.name CAPITAL
from allcountry_aostats,country_ao,city_ao
where allcountry_aostats.code = country_ao.code
and country_ao.capital = city_ao.id
and CITY_AO_CNT/LANG_CNT > 1
and country_ao.continent = 'North America'
UNION ALL
select allcountry_aostats.code,allcountry_aostats.name COUNTRY_AO,CITY_AO_CNT,LANG_CNT,country_ao.region,city_ao.name CAPITAL
from allcountry_aostats,country_ao,city_ao
where allcountry_aostats.code = country_ao.code
and country_ao.capital = city_ao.id
and CITY_AO_CNT/LANG_CNT > (select  max(CITY_AO_CNT/LANG_CNT)  from allcountry_aostats,country_ao where allcountry_aostats.code = country_ao.code AND country_ao.continent='Europe')
) FOO
,allcountry_aostats,country_ao
WHERE allcountry_aostats.code = country_ao.code
and FOO.region = country_ao.region
group by FOO.region order by FOO.region;
 region_city_ao_cnt | region_lang_cnt |          region           
--------------------+-----------------+---------------------------
                840 |             192 | Caribbean
               2824 |             112 | Central America
              11336 |             384 | Eastern Asia
               2664 |             396 | Middle East
               1625 |             125 | North America
               3500 |              70 | South America
               3179 |             528 | Southeast Asia
              12278 |             896 | Southern and Central Asia
(8 rows)

-- some queries with hash joins and index scans
set enable_nestloop=off;
SET
set enable_hashjoin=on;
SET
set enable_mergejoin=off;
SET
--query 9
with diversecountries as
(select country_ao.code,country_ao.name,country_ao.capital,d.CNT
 from country_ao,
 (select countrylanguage_ao.countrycode,count(*) as CNT from countrylanguage_ao group by countrycode
  HAVING count(*) > 6) d
 where d.countrycode = country_ao.code and country_ao.gnp > 100000)
select d1.code,d1.name,d1.capital,city_ao.name CAPITAL_CITY_AO,d1.CNT,d2.CNT
from
diversecountries d1 left join country_ao
ON (d1.code = country_ao.code AND d1.CNT < 8)
left join diversecountries d2
ON (country_ao.code = d2.code AND d2.CNT > 8)
INNER JOIN city_ao
ON(d1.capital = city_ao.id)
ORDER BY d1.name;
 code |        name        | capital | capital_city_ao  | cnt | cnt 
------+--------------------+---------+------------------+-----+-----
 AUS  | Australia          |     135 | Canberra         |   8 |    
 AUT  | Austria            |    1523 | Wien             |   8 |    
 CAN  | Canada             |    1822 | Ottawa           |  12 |    
 CHN  | China              |    1891 | Peking           |  12 |    
 DNK  | Denmark            |    3315 | Kobenhavn        |   7 |    
 IND  | India              |    1109 | New Delhi        |  12 |    
 IRN  | Iran               |    1380 | Teheran          |  10 |    
 ITA  | Italy              |    1464 | Roma             |   8 |    
 MMR  | Myanmar            |    2710 | Rangoon (Yangon) |   8 |    
 RUS  | Russian Federation |    3580 | Moscow           |  12 |    
 ZAF  | South Africa       |     716 | Pretoria         |  11 |    
 USA  | United States      |    3813 | Washington       |  12 |    
(12 rows)

--query 10 , multiple ctes, joins
with longlivingregions as 
(
select FOO.*,count(distinct language) as "lang_count"
from(
     select
       sum(population) as "REGION_POP",
       sum(gnp) as "REGION_GNP",
       avg(lifeexpectancy) as "REGION_LIFETIME",region
     from
      country_ao
     group by region
    ) FOO,countrylanguage_ao,country_ao
where
   country_ao.code = countrylanguage_ao.countrycode
   and FOO.region = country_ao.region
group by
FOO.region,foo."REGION_POP",foo."REGION_GNP",foo."REGION_LIFETIME"),
denseregions as 
(
select FOO.*,count(distinct language) as "lang_count",
       sum(surfacearea) as "REGION_SURFACE_AREA"
from(
     select
       sum(population) as "REGION_POP",
       sum(gnp) as "REGION_GNP",
       region
     from
      country_ao
     group by region
    ) FOO,countrylanguage_ao,country_ao
where
   country_ao.code = countrylanguage_ao.countrycode
   and FOO.region = country_ao.region
   and FOO."REGION_POP" != 0
group by
FOO.region,foo."REGION_POP",foo."REGION_GNP"
order by sum(surfacearea)/foo."REGION_POP" desc),
allcountry_aostats as 
( select country_ao.code,country_ao.name,count(distinct city_ao.id) CITY_AO_CNT,
  count(distinct countrylanguage_ao.language) LANG_CNT
  from country_ao,city_ao,countrylanguage_ao
  where country_ao.code = city_ao.countrycode
  and country_ao.code = countrylanguage_ao.countrycode
  group by country_ao.code,country_ao.name
)
select allcountry_aostats.CITY_AO_CNT,allcountry_aostats.LANG_CNT,allcountry_aostats.name,
       "REGION_SURFACE_AREA","REGION_LIFETIME",longlivingregions."REGION_POP",longlivingregions.lang_count,longlivingregions."REGION_GNP",longlivingregions.region
from longlivingregions,denseregions,allcountry_aostats,country_ao
where longlivingregions.region = denseregions.region and allcountry_aostats.code = country_ao.code and country_ao.region = longlivingregions.region
and country_ao.indepyear between 1800 and 1850
UNION ALL
select allcountry_aostats.CITY_AO_CNT,allcountry_aostats.LANG_CNT,allcountry_aostats.name,
       "REGION_SURFACE_AREA","REGION_LIFETIME",longlivingregions."REGION_POP",longlivingregions.lang_count,longlivingregions."REGION_GNP",longlivingregions.region
from longlivingregions,denseregions,allcountry_aostats,country_ao
where longlivingregions.region = denseregions.region and allcountry_aostats.code = country_ao.code and country_ao.region = longlivingregions.region
and country_ao.indepyear between 1850 and 1900
UNION ALL
select allcountry_aostats.CITY_AO_CNT,allcountry_aostats.LANG_CNT,allcountry_aostats.name,
       "REGION_SURFACE_AREA","REGION_LIFETIME",longlivingregions."REGION_POP",longlivingregions.lang_count,longlivingregions."REGION_GNP",longlivingregions.region
from longlivingregions,denseregions,allcountry_aostats,country_ao
where longlivingregions.region = denseregions.region and allcountry_aostats.code = country_ao.code and country_ao.region = longlivingregions.region
and country_ao.indepyear > 1900
order by name
LIMIT 50;
 city_ao_cnt | lang_cnt |                 name                  | REGION_SURFACE_AREA | REGION_LIFETIME  | REGION_POP | lang_count | REGION_GNP |          region           
-------------+----------+---------------------------------------+---------------------+------------------+------------+------------+------------+---------------------------
           4 |        5 | Afghanistan                           |         9.07498e+07 | 61.3500003814697 | 1490776000 |         54 |  810604.00 | Southern and Central Asia
           1 |        3 | Albania                               |          5.8452e+06 | 76.5285720825195 |  144674200 |         22 | 2012289.00 | Southern Europe
          18 |        2 | Algeria                               |         3.69935e+07 | 65.3857127598354 |  173266000 |         14 |  243870.00 | Northern Africa
           5 |        9 | Angola                                |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
           1 |        2 | Antigua and Barbuda                   |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
          57 |        3 | Argentina                             |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
           3 |        2 | Armenia                               |         1.01537e+07 | 70.5666671329074 |  188380700 |         21 |  677260.00 | Middle East
          14 |        8 | Australia                             |         6.24712e+07 | 78.8000030517578 |   22753100 |         11 |  405851.00 | Australia and New Zealand
           6 |        8 | Austria                               |         6.64977e+06 | 78.2555567423503 |  183247600 |         21 | 4673272.00 | Western Europe
           4 |        4 | Azerbaijan                            |         1.01537e+07 | 70.5666671329074 |  188380700 |         21 |  677260.00 | Middle East
           1 |        2 | Bahamas                               |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
           1 |        2 | Bahrain                               |         1.01537e+07 | 70.5666671329074 |  188380700 |         21 |  677260.00 | Middle East
          24 |        7 | Bangladesh                            |         9.07498e+07 | 61.3500003814697 | 1490776000 |         54 |  810604.00 | Southern and Central Asia
           1 |        2 | Barbados                              |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
          16 |        4 | Belarus                               |         2.14732e+08 | 69.9299995422363 |  307026000 |         28 |  659980.00 | Eastern Europe
           9 |        6 | Belgium                               |         6.64977e+06 | 78.2555567423503 |  183247600 |         21 | 4673272.00 | Western Europe
           2 |        4 | Belize                                |         1.40524e+07 | 71.0249996185303 |  135221000 |         23 |  473151.00 | Central America
           4 |        7 | Benin                                 |         3.97449e+07 | 52.7411768296186 |  221672000 |         65 |  106711.00 | Western Africa
           1 |        3 | Bhutan                                |         9.07498e+07 | 61.3500003814697 | 1490776000 |         54 |  810604.00 | Southern and Central Asia
           8 |        4 | Bolivia                               |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
           3 |        1 | Bosnia and Herzegovina                |          5.8452e+06 | 76.5285720825195 |  144674200 |         22 | 2012289.00 | Southern Europe
           2 |        5 | Botswana                              |         2.30602e+07 | 44.8199996948242 |   46886000 |         21 |  126931.00 | Southern Africa
         250 |        5 | Brazil                                |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
           1 |        4 | Brunei                                |         3.53222e+07 | 64.4000001387163 |  518541000 |         47 |  642643.00 | Southeast Asia
          10 |        4 | Bulgaria                              |         2.14732e+08 | 69.9299995422363 |  307026000 |         28 |  659980.00 | Eastern Europe
           3 |        6 | Burkina Faso                          |         3.97449e+07 | 52.7411768296186 |  221672000 |         65 |  106711.00 | Western Africa
           1 |        3 | Burundi                               |         4.36313e+07 | 50.8105261953254 |  246999000 |         80 |   69925.00 | Eastern Africa
           3 |        4 | Cambodia                              |         3.53222e+07 | 64.4000001387163 |  518541000 |         47 |  642643.00 | Southeast Asia
           7 |        8 | Cameroon                              |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
          49 |       12 | Canada                                |         2.36342e+08 | 75.8199996948242 |  309632000 |         18 | 9111890.00 | North America
           1 |        2 | Cape Verde                            |         3.97449e+07 | 52.7411768296186 |  221672000 |         65 |  106711.00 | Western Africa
           1 |        6 | Central African Republic              |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
           2 |        8 | Chad                                  |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
          29 |        4 | Chile                                 |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
          38 |        5 | Colombia                              |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
           1 |        5 | Comoros                               |         4.36313e+07 | 50.8105261953254 |  246999000 |         80 |   69925.00 | Eastern Africa
           2 |        6 | Congo                                 |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
          18 |       10 | Congo, The Democratic Republic of the |          5.5663e+07 | 50.3111110263401 |   95652000 |         47 |   32938.00 | Central Africa
           1 |        4 | Costa Rica                            |         1.40524e+07 | 71.0249996185303 |  135221000 |         23 |  473151.00 | Central America
           5 |        5 | Cote deIvoire                         |         3.97449e+07 | 52.7411768296186 |  221672000 |         65 |  106711.00 | Western Africa
           4 |        2 | Croatia                               |          5.8452e+06 | 76.5285720825195 |  144674200 |         22 | 2012289.00 | Southern Europe
          14 |        1 | Cuba                                  |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
           2 |        2 | Cyprus                                |         1.01537e+07 | 70.5666671329074 |  188380700 |         21 |  677260.00 | Middle East
          10 |        8 | Czech Republic                        |         2.14732e+08 | 69.9299995422363 |  307026000 |         28 |  659980.00 | Eastern Europe
           1 |        3 | Djibouti                              |         4.36313e+07 | 50.8105261953254 |  246999000 |         80 |   69925.00 | Eastern Africa
           1 |        2 | Dominica                              |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
           6 |        2 | Dominican Republic                    |              363261 | 73.0583332379659 |   38140000 |         10 |  103586.20 | Caribbean
          15 |        2 | Ecuador                               |         7.43182e+07 | 70.9461532005897 |  345780000 |         21 | 1511874.00 | South America
          37 |        2 | Egypt                                 |         3.69935e+07 | 65.3857127598354 |  173266000 |         14 |  243870.00 | Northern Africa
           7 |        2 | El Salvador                           |         1.40524e+07 | 71.0249996185303 |  135221000 |         23 |  473151.00 | Central America
(50 rows)

--query 11
with allcity_aostats as 
( select city_ao.name CITY_AO,city_ao.id,country_ao.name COUNTRY_AO,city_ao.district,city_ao.population as CITY_AO_POP
  from
  city_ao,country_ao
  where city_ao.countrycode = country_ao.code
),
alldistrictstats as 
( select allcity_aostats.district,allcity_aostats.COUNTRY_AO,sum(CITY_AO_POP) DISTRICT_POP,
  count(CITY_AO) as D_CITY_AO_CNT
  from allcity_aostats
  group by allcity_aostats.district,allcity_aostats.COUNTRY_AO
  order by district,COUNTRY_AO
),
allcountry_aostats as 
( select alldistrictstats.COUNTRY_AO,country_ao.code,sum(D_CITY_AO_CNT) C_CITY_AO_CNT,
  count(distinct countrylanguage_ao.language) C_LANG_CNT
  from alldistrictstats,country_ao,countrylanguage_ao
  where alldistrictstats.COUNTRY_AO = country_ao.name
  and country_ao.code = countrylanguage_ao.countrycode
  group by COUNTRY_AO,code
),
asian_region_stats as 
(
select sum(FOO.C_CITY_AO_CNT) REGION_CITY_AO_CNT,sum(FOO.C_LANG_CNT) REGION_LANG_CNT,FOO.region
FROM
(
select allcountry_aostats.code,allcountry_aostats.COUNTRY_AO,C_CITY_AO_CNT,C_LANG_CNT,country_ao.region,city_ao.name CAPITAL
from allcountry_aostats,country_ao,city_ao
where allcountry_aostats.code = country_ao.code
and country_ao.capital = city_ao.id
and C_CITY_AO_CNT/C_LANG_CNT > 1
and country_ao.continent = 'Asia') FOO
,allcountry_aostats,country_ao
WHERE allcountry_aostats.code = country_ao.code
and FOO.region = country_ao.region
group by FOO.region order by FOO.region
)
select * from
(
select REGION_CITY_AO_CNT as CITY_AO_CNT,REGION_LANG_CNT as LANG_CNT, region as IDENTIFIER from asian_region_stats
UNION ALL
(
select sum(FOO.C_CITY_AO_CNT) CITY_AO_CNT,sum(FOO.C_LANG_CNT) LANG_CNT,FOO.region as IDENTIFIER
FROM
(
select allcountry_aostats.code,allcountry_aostats.COUNTRY_AO,C_CITY_AO_CNT,C_LANG_CNT,country_ao.region,allcity_aostats.CITY_AO CAPITAL
from allcountry_aostats,country_ao,allcity_aostats
where allcountry_aostats.code = country_ao.code
and country_ao.capital = allcity_aostats.id
and C_CITY_AO_CNT/C_LANG_CNT > 1
and country_ao.continent = 'Europe') FOO
,allcountry_aostats,country_ao
WHERE allcountry_aostats.code = country_ao.code
and FOO.region = country_ao.region
group by FOO.region order by FOO.region
)
) FOO1
order by FOO1.lang_cnt,FOO1.identifier;
 city_ao_cnt | lang_cnt |        identifier         
-------------+----------+---------------------------
         494 |       10 | British Islands
         159 |       48 | Baltic Countries
        1295 |      161 | Nordic Countries
       50176 |      264 | Eastern Asia
        9414 |      369 | Western Europe
       11880 |      450 | Southern Europe
       32900 |      610 | Eastern Europe
       29161 |      616 | Southeast Asia
        8568 |      792 | Middle East
       80388 |     1092 | Southern and Central Asia
(10 rows)

