-- @description : Create Updatable AO tables , with indexes different distributions
-- 
-- create select uao table with  No distribution (hence hash distribution)
DROP TABLE IF EXISTS  uao_tab_distrib_none cascade;
DROP TABLE
CREATE TABLE uao_tab_distrib_none  with (appendonly=true, orientation=column )  AS (
SELECT GENERATE_SERIES::numeric sno
     , (random() * 10000000)::numeric + 10000000 val1
     , timeofday()::varchar(50) val2
     , (random() * 5000)::bigint + 10000000 val3
     , (random() * 10000000)::numeric + 10000000 val4
     , (random() * 10000000)::numeric + 10000000 val5	
  FROM GENERATE_SERIES(10000, 19999)
) ;
psql:/path/sql_file:1: NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'sno' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SELECT 10000
CREATE index val3_bmp_idx_uao_tab_distrib_none on uao_tab_distrib_none using bitmap (val3);
CREATE INDEX
\d+ uao_tab_distrib_none;
                                Append-Only Columnar Table "public.uao_tab_distrib_none"
 Column |         Type          | Modifiers | Storage  | Compression Type | Compression Level | Block Size | Description 
--------+-----------------------+-----------+----------+------------------+-------------------+------------+-------------
 sno    | numeric               |           | main     | none             | 0                 | 32768      | 
 val1   | numeric               |           | main     | none             | 0                 | 32768      | 
 val2   | character varying(50) |           | extended | none             | 0                 | 32768      | 
 val3   | bigint                |           | plain    | none             | 0                 | 32768      | 
 val4   | numeric               |           | main     | none             | 0                 | 32768      | 
 val5   | numeric               |           | main     | none             | 0                 | 32768      | 
Checksum: f
Indexes:
    "val3_bmp_idx_uao_tab_distrib_none" bitmap (val3)
Has OIDs: no
Options: appendonly=true, orientation=column
Distributed by: (sno)

SELECT count(*) AS cnt_row_distrib_none from uao_tab_distrib_none;
 cnt_row_distrib_none 
----------------------
                10000
(1 row)

SELECT 1 AS VisimapPresent  FROM pg_appendonly WHERE visimapidxid is not NULL AND visimapidxid is not NULL AND relid=(SELECT oid FROM pg_class WHERE relname='uao_tab_distrib_none');
 visimappresent 
----------------
              1
(1 row)

-- create select uao table with  distributed by sno
DROP TABLE IF EXISTS uao_tab_distrib_key cascade;
DROP TABLE
CREATE TABLE uao_tab_distrib_key  with (appendonly=true, orientation=column )  AS (
SELECT GENERATE_SERIES::numeric sno
     , (random() * 10000000)::numeric + 10000000 val1
     , timeofday()::varchar(50) val2
     , (random() * 5000)::bigint + 10000000 val3
     , (random() * 10000000)::numeric + 10000000 val4
     , (random() * 10000000)::numeric + 10000000 val5	
  FROM GENERATE_SERIES(10000, 19999)
) DISTRIBUTED BY (sno) ;
SELECT 10000
CREATE index val3_bmp_idx_uao_tab_distrib_key on uao_tab_distrib_key using bitmap (val3);
CREATE INDEX
\d+ uao_tab_distrib_key;
                                 Append-Only Columnar Table "public.uao_tab_distrib_key"
 Column |         Type          | Modifiers | Storage  | Compression Type | Compression Level | Block Size | Description 
--------+-----------------------+-----------+----------+------------------+-------------------+------------+-------------
 sno    | numeric               |           | main     | none             | 0                 | 32768      | 
 val1   | numeric               |           | main     | none             | 0                 | 32768      | 
 val2   | character varying(50) |           | extended | none             | 0                 | 32768      | 
 val3   | bigint                |           | plain    | none             | 0                 | 32768      | 
 val4   | numeric               |           | main     | none             | 0                 | 32768      | 
 val5   | numeric               |           | main     | none             | 0                 | 32768      | 
Checksum: f
Indexes:
    "val3_bmp_idx_uao_tab_distrib_key" bitmap (val3)
Has OIDs: no
Options: appendonly=true, orientation=column
Distributed by: (sno)

SELECT count(*) AS cnt_row_distrib_key from uao_tab_distrib_key;
 cnt_row_distrib_key 
---------------------
               10000
(1 row)

SELECT 1 AS VisimapPresent  FROM pg_appendonly WHERE visimapidxid is not NULL AND visimapidxid is not NULL AND relid=(SELECT oid FROM pg_class WHERE relname='uao_tab_distrib_key');
 visimappresent 
----------------
              1
(1 row)

-- create select uao table with  distributed randomly
DROP TABLE IF EXISTS  uao_tab_distrib_randomly cascade;
DROP TABLE
CREATE TABLE uao_tab_distrib_randomly  with (appendonly=true, orientation=column )  AS (
SELECT GENERATE_SERIES::numeric sno
     , (random() * 10000000)::numeric + 10000000 val1
     , timeofday()::varchar(50) val2
     , (random() * 5000)::bigint + 10000000 val3
     , (random() * 10000000)::numeric + 10000000 val4
     , (random() * 10000000)::numeric + 10000000 val5	
  FROM GENERATE_SERIES(10000, 19999)
) DISTRIBUTED randomly ;
SELECT 10000
CREATE index val3_bmp_idx_uao_tab_distrib_randomly on uao_tab_distrib_randomly using bitmap (val3);
CREATE INDEX
\d+ uao_tab_distrib_randomly;
                              Append-Only Columnar Table "public.uao_tab_distrib_randomly"
 Column |         Type          | Modifiers | Storage  | Compression Type | Compression Level | Block Size | Description 
--------+-----------------------+-----------+----------+------------------+-------------------+------------+-------------
 sno    | numeric               |           | main     | none             | 0                 | 32768      | 
 val1   | numeric               |           | main     | none             | 0                 | 32768      | 
 val2   | character varying(50) |           | extended | none             | 0                 | 32768      | 
 val3   | bigint                |           | plain    | none             | 0                 | 32768      | 
 val4   | numeric               |           | main     | none             | 0                 | 32768      | 
 val5   | numeric               |           | main     | none             | 0                 | 32768      | 
Checksum: f
Indexes:
    "val3_bmp_idx_uao_tab_distrib_randomly" bitmap (val3)
Has OIDs: no
Options: appendonly=true, orientation=column
Distributed randomly

SELECT count(*) AS cnt_row_distrib_random from uao_tab_distrib_randomly;
 cnt_row_distrib_random 
------------------------
                  10000
(1 row)

SELECT 1 AS VisimapPresent  FROM pg_appendonly WHERE visimapidxid is not NULL AND visimapidxid is not NULL AND relid=(SELECT oid FROM pg_class WHERE relname='uao_tab_distrib_randomly');
 visimappresent 
----------------
              1
(1 row)

